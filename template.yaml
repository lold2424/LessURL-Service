AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  LessURL-Serverless

  Java 21 & SnapStart based URL Shortener Service

Parameters:
  HostedZoneId:
    Type: String
    Default: "Z079670437KXXERC398XZ"
    Description: "Route 53 Hosted Zone ID for lessurl.site"
  CorsAllowedOrigin:
    Type: String
    Default: "https://app.lessurl.site"
  GeminiApiKey:
    Type: String
    Description: Gemini API 키
    NoEcho: true
  SafeBrowsingApiKey:
    Type: String
    Description: Google Safe Browsing API 키
    NoEcho: true
  BaseUrl:
    Type: String
    Default: "https://lessurl.site"
    Description: "단축 URL의 베이스 도메인"

Globals:
  Function:
    Timeout: 60
    MemorySize: 1024
    Runtime: java21
    Architectures:
      - x86_64
    AutoPublishAlias: live
    Environment:
      Variables:
        URLS_TABLE: !Ref UrlsTable
        CLICKS_TABLE: !Ref ClicksTable
        TREND_INSIGHTS_TABLE: !Ref TrendInsightsTable
        AI_ANALYTIC_TABLE: !Ref AiAnalyticTable
        CORS_ALLOWED_ORIGIN: !Ref CorsAllowedOrigin
        DYNAMODB_ENDPOINT: ""

Resources:
  # 1. SSL 인증서 생성
  ApiCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: "lessurl.site"
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: "lessurl.site"
          HostedZoneId: !Ref HostedZoneId

  # API Gateway
  UrlShortenerApi:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowMethods: "'GET,POST,OPTIONS'"
        AllowHeaders: "'Content-Type'"
        AllowOrigin: "'*'"
      # 백엔드가 메인 도메인을 차지합니다
      Domain:
        DomainName: "lessurl.site"
        CertificateArn: !Ref ApiCertificate
        Route53:
          HostedZoneId: !Ref HostedZoneId
        EndpointConfiguration: REGIONAL

  # DynamoDB Tables (기존 설정 유지)
  UrlsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: urls
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: shortId
          AttributeType: S
        - AttributeName: customAlias
          AttributeType: S
        - AttributeName: visibility
          AttributeType: S
        - AttributeName: createdAt
          AttributeType: S
      KeySchema:
        - AttributeName: shortId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: VisibilityIndex
          KeySchema:
            - AttributeName: visibility
              KeyType: HASH
            - AttributeName: createdAt
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
        - IndexName: CustomAliasIndex
          KeySchema:
            - AttributeName: customAlias
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  ClicksTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: clicks
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: shortId
          AttributeType: S
        - AttributeName: timestamp
          AttributeType: S
      KeySchema:
        - AttributeName: shortId
          KeyType: HASH
        - AttributeName: timestamp
          KeyType: RANGE

  TrendInsightsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: trendInsights
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: shortId
          AttributeType: S
        - AttributeName: category
          AttributeType: S
      KeySchema:
        - AttributeName: shortId
          KeyType: HASH
        - AttributeName: category
          KeyType: RANGE

  AiAnalyticTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: AIAnalytic
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: shortId
          AttributeType: S
        - AttributeName: generatedAt
          AttributeType: S
      KeySchema:
        - AttributeName: shortId
          KeyType: HASH
        - AttributeName: generatedAt
          KeyType: RANGE

  # Lambda Functions
  ShortenFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LessUrlFunction
      Handler: lessurl.ShortenHandler::handleRequest
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          GEMINI_API_KEY: !Ref GeminiApiKey
          SAFE_BROWSING_API_KEY: !Ref SafeBrowsingApiKey
          BASE_URL: !Ref BaseUrl
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref UrlShortenerApi
            Path: /shorten
            Method: POST
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource: !GetAtt UrlsTable.Arn

  RedirectFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LessUrlFunction
      Handler: lessurl.RedirectHandler::handleRequest
      SnapStart:
        ApplyOn: PublishedVersions
      Environment:
        Variables:
          ANALYTICS_FUNCTION_NAME: !Ref AnalyticsFunction
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref UrlShortenerApi
            Path: /{shortId}
            Method: GET
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Query
              Resource: 
                - !GetAtt UrlsTable.Arn
                - !Sub "${UrlsTable.Arn}/index/CustomAliasIndex"
            - Effect: Allow
              Action:
                - lambda:InvokeFunction
              Resource: !GetAtt AnalyticsFunction.Arn

  AnalyticsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LessUrlFunction
      Handler: lessurl.AnalyticsHandler::handleRequest
      SnapStart:
        ApplyOn: PublishedVersions
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
              Resource: !GetAtt UrlsTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource: !GetAtt ClicksTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
              Resource: !GetAtt TrendInsightsTable.Arn

  StatsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LessUrlFunction
      Handler: lessurl.StatsHandler::handleRequest
      SnapStart:
        ApplyOn: PublishedVersions
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref UrlShortenerApi
            Path: /stats/{shortId}
            Method: GET
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource: !GetAtt UrlsTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:Query
              Resource: !GetAtt ClicksTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
              Resource: !GetAtt TrendInsightsTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:PutItem
                - dynamodb:Query
              Resource: !GetAtt AiAnalyticTable.Arn

  ListPublicFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: LessUrlFunction
      Handler: lessurl.ListPublicHandler::handleRequest
      SnapStart:
        ApplyOn: PublishedVersions
      Events:
        ApiEvent:
          Type: Api
          Properties:
            RestApiId: !Ref UrlShortenerApi
            Path: /public-urls
            Method: GET
      Policies:
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
              Resource: 
                - !GetAtt UrlsTable.Arn
                - !Sub "${UrlsTable.Arn}/index/VisibilityIndex"

  MonitoringTopic:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: "LessUrl-Alarms"
      Subscription:
        - Protocol: email
          Endpoint: "lold2424@gmail.com"

  ShortenErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-shorten-errors"
      AlarmDescription: "ShortenFunction Errors > 10/min"
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ShortenFunction
      AlarmActions:
        - !Ref MonitoringTopic

  ShortenDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-shorten-duration"
      AlarmDescription: "ShortenFunction Duration > 3s"
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 60
      EvaluationPeriods: 1
      Threshold: 3000
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ShortenFunction
      AlarmActions:
        - !Ref MonitoringTopic

  RedirectErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-redirect-errors"
      AlarmDescription: "RedirectFunction Errors > 10/min"
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref RedirectFunction
      AlarmActions:
        - !Ref MonitoringTopic

  RedirectDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-redirect-duration"
      AlarmDescription: "RedirectFunction Duration > 3s"
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 60
      EvaluationPeriods: 1
      Threshold: 3000
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref RedirectFunction
      AlarmActions:
        - !Ref MonitoringTopic

  StatsErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-stats-errors"
      AlarmDescription: "StatsFunction Errors > 10/min"
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref StatsFunction
      AlarmActions:
        - !Ref MonitoringTopic

  StatsDurationAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-stats-duration"
      AlarmDescription: "StatsFunction Duration > 3s"
      MetricName: Duration
      Namespace: AWS/Lambda
      Statistic: Average
      Period: 60
      EvaluationPeriods: 1
      Threshold: 3000
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref StatsFunction
      AlarmActions:
        - !Ref MonitoringTopic

  ApiGateway5xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-api-5xx"
      AlarmDescription: "API 5XX > 5/min"
      MetricName: 5XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Ref UrlShortenerApi
      AlarmActions:
        - !Ref MonitoringTopic

  ApiGateway4xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-api-4xx"
      AlarmDescription: "API 4XX > 50/min"
      MetricName: 4XXError
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 50
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiName
          Value: !Ref UrlShortenerApi
      AlarmActions:
        - !Ref MonitoringTopic

  DynamoDbThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub "${AWS::StackName}-ddb-throttles"
      AlarmDescription: "DynamoDB Throttled Events"
      Namespace: AWS/DynamoDB
      MetricName: ReadThrottleEvents
      Dimensions:
        - Name: TableName
          Value: !Ref UrlsTable
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 1
      Threshold: 0
      ComparisonOperator: GreaterThanThreshold
      AlarmActions:
        - !Ref MonitoringTopic

Outputs:
  ApiEndpoint:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${UrlShortenerApi}.execute-api.${AWS::Region}.amazonaws.com/prod"

  UrlsTableName:
    Description: "URLs DynamoDB Table"
    Value: !Ref UrlsTable

  ClicksTableName:
    Description: "Clicks DynamoDB Table"
    Value: !Ref ClicksTable
